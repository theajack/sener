<!--
 * @Author: chenzhongsheng
 * @Date: 2023-02-13 17:02:26
 * @Description: Coding something
-->
<p align="center">
    <img src='https://shiyix.cn/images/sener.png' width='120px'/>
</p> 

<p align="center">
    <a href="https://www.github.com/theajack/sener/stargazers" target="_black">
        <img src="https://img.shields.io/github/stars/theajack/sener?logo=github" alt="stars" />
    </a>
    <a href="https://www.github.com/theajack/sener/network/members" target="_black">
        <img src="https://img.shields.io/github/forks/theajack/sener?logo=github" alt="forks" />
    </a>
    <a href="https://www.npmjs.com/package/sener" target="_black">
        <img src="https://img.shields.io/npm/v/sener?logo=npm" alt="version" />
    </a>
    <a href="https://www.npmjs.com/package/sener" target="_black">
        <img src="https://img.shields.io/npm/dm/sener?color=%23ffca28&logo=npm" alt="downloads" />
    </a>
    <a href="https://www.jsdelivr.com/package/npm/sener" target="_black">
        <img src="https://data.jsdelivr.com/v1/package/npm/sener/badge" alt="jsdelivr" />
    </a>
</p>

<p align="center">
    <a href="https://github.com/theajack" target="_black">
        <img src="https://img.shields.io/badge/Author-%20theajack%20-7289da.svg?&logo=github" alt="author" />
    </a>
    <a href="https://www.github.com/theajack/sener/blob/master/LICENSE" target="_black">
        <img src="https://img.shields.io/github/license/theajack/sener?color=%232DCE89&logo=github" alt="license" />
    </a>
    <a href="https://fastly.jsdelivr.net/gh/theajack/sener/dist/sener.latest.min.js"><img src="https://img.shields.io/bundlephobia/minzip/sener.svg" alt="Size"></a>
    <a href="https://github.com/theajack/sener/search?l=javascript"><img src="https://img.shields.io/github/languages/top/theajack/sener.svg" alt="TopLang"></a>
    <a href="https://github.com/theajack/sener/issues"><img src="https://img.shields.io/github/issues-closed/theajack/sener.svg" alt="issue"></a>
    <a href="https://www.github.com/theajack/sener"><img src="https://img.shields.io/librariesio/dependent-repos/npm/sener.svg" alt="Dependent"></a>
</p>

<h3>ğŸš€ ç®€å•æ˜“ç”¨ã€åŠŸèƒ½å¼ºå¤§ã€é«˜å¯æ‰©å±•çš„nodejs httpæœåŠ¡å™¨</h3>

**[åœ¨çº¿æ–‡æ¡£](https://theajack.github.io/sener/) | [English](https://github.com/theajack/sener) | [æ›´æ–°æ—¥å¿—](https://github.com/theajack/cnchar/blob/master/scripts/version.cn.md) | [åé¦ˆ](https://github.com/theajack/sener/issues/new) | [Gitee](https://gitee.com/theajack/sener) | [ç•™è¨€æ¿](https://theajack.github.io/message-board/?app=sener)**


## 1. ç‰¹æ€§

1. ç®€å•é«˜æ•ˆçš„æ¶æ„ï¼Œå…¨tsç¼–å†™ï¼Œé«˜åº¦å‹å¥½çš„tså£°æ˜æ”¯æŒ
2. æ”¯æŒé«˜åº¦è‡ªå®šä¹‰å’Œé«˜å¯æ‰©å±•çš„ä¸­é—´ä»¶ä½“ç³»ï¼Œé‡‡ç”¨æ´‹è‘±æ¨¡å‹ï¼Œä¸°å¯Œçš„è·¯ç”±hooks

å†…ç½®ä¸­é—´ä»¶ï¼š

å†…ç½®ä¸­é—´ä»¶ä¸ºseneråŒ…ä¸­è‡ªå¸¦çš„ä¸­é—´ ä½†æ˜¯ä½¿ç”¨æ—¶ä¹Ÿéœ€è¦æ‰‹åŠ¨å¼•å…¥

1. routerï¼šç®€å•é«˜å¯æ‰©å±•çš„è·¯ç”±è§„åˆ™
2. cookieï¼šç”¨äºcookieè·å–å’Œæ³¨å…¥
3. sessionï¼šç”¨äºsessionè·å–å’Œæ³¨å…¥ï¼ˆä¾èµ–cookieï¼‰
4. envï¼šç”¨äºæ³¨å…¥å’Œä½¿ç”¨ç¯å¢ƒå˜é‡
5. corsï¼šæ”¯æŒè·¨åŸŸè¯·æ±‚
6. ip-monitorï¼šç”¨äºå¯¹è¯·æ±‚ipè¿›è¡Œé£æ§æ‹¦æˆª
7. validatorï¼šæ”¯æŒéªŒè¯å…¥å‚å’Œå‚æ•°ç±»å‹å®šä¹‰

ç‹¬ç«‹ä¸­é—´ä»¶ï¼š

ä½¿ç”¨ç‹¬ç«‹ä¸­é—´éœ€è¦å®‰è£…å¯¹åº”çš„ç‹¬ç«‹åŒ…

1. jsonï¼šæ”¯æŒjsonæ–‡ä»¶ç”¨äºæ•°æ®å­˜å‚¨
2. staticï¼šæ”¯æŒé™æ€æ–‡ä»¶ç›®å½•
3. formï¼šæ”¯æŒformdataè§£æå’Œæ–‡ä»¶ä¸Šä¼ 
4. configï¼šæ”¯æŒé«˜åº¦çµæ´»çš„å‚æ•°é…ç½®å’ŒåŠ¨æ€å˜æ›´ä¸ç›‘å¬
5. logï¼šæ”¯æŒçµæ´»çš„æ—¥å¿—ä½“ç³»ï¼Œæ”¯æŒæ—¥å¿—çº§åˆ«æ§åˆ¶
6. mysqlï¼šæ”¯æŒmysqlè¿æ¥
7. mongodbï¼šæ”¯æŒmongodbè¿æ¥ï¼Œcollocationçš„å°è£…
8. rpcï¼šè¿œç¨‹è°ƒç”¨æ”¯æŒï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ï¼Œæ”¯æŒæ³¨å…¥è¯·æ±‚çš„x-trace-id

## 2. åŸºç¡€ä½¿ç”¨

```
npm i sener
```

æœ€ç®€demo:

```js
import {Sener} from 'sener';
new Sener();
```

options:

```js
new Sener({
  port: 9000, // port: default value is 9000
  middlewares: [], // Sener middlewares
});
```

### æœ€ä½³å®è·µ

1. ä½¿ç”¨ebuild-cli

```
npm i ebuild-cli -g
ebuild init <Project name>
cd <Project name>
npm i
```

åœ¨éšåçš„æ¨¡å¼é€‰æ‹©ä¸­ é€‰æ‹© sener å³å¯

2. ä»[githubåœ°å€](https://github.com/theajack/sener-best-practice)ä¸Šæ‹·è´

```
git clone https://github.com/theajack/sener-best-practice.git
```

## 3. ä¸­é—´ä»¶

### 3.1 router

è·¯ç”±ä¸­é—´ä»¶

```js
import {Sener, Router} from 'sener';
const router = new Router({
    '/demo': ({ query }) => {
    // or: 'get:/demo': ({ query }) => { // get: prefix can be ignored
        query.message = 'from get';
        return { data: query };
        // Custom headers or statusCode
        // return { data: query, headers: {}, statusCode: 200  };
    },
    'post:/demo': async ({ body }) => {
        body.message = 'from post'
        return { data: body };
    },
});
new Sener({
  // router è¦ä½äºä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ª
  middlewares: [router], 
});
```


### 3.2 json

ä½¿ç”¨jsonæ–‡ä»¶è¿›è¡Œæ•°æ®å­˜å‚¨

```
npm i sener sener-json
```

```js
import {Sener, Router} from 'sener';
import {Json} from 'sener-json';
const router = new Router({
    '/data': ({ query, read }) => {
        // 'data' is json file name
        return { data: read('data') };
    },
    'post:/data': async ({ body, write }) => {
        const { data, save, id } = write('aa');
        body.message = 'from post'
        data.push({...body, id: id()}); // Add increment id
        save(); // save it, THIS Method must be called
        return { data };
    },
});
new Sener({
  middlewares: [router, new Json()],
});
```

å¯é€‰å‚æ•°ï¼š

```js
new Json({
  dir: '', // directory for save json files. default value is ''
  format: false, // Whether to format the JSON file. Default value: The development environment is false and the production environment is true
})
```

### 3.3 cors

```
npm i sener sener-cors
```

æ”¯æŒè·¨åŸŸè¯·æ±‚çš„ä¸­é—´ä»¶

```js
import {Sener, Cors} from 'sener';
new Sener({
  middlewares: [new Cors()], 
  // new Cors(header); Or Set your custom headers
});
```

å¯é€‰å‚æ•°

```js
new Cors({
  // headers: Set your custom headers
})
```

### 3.4 static

æ”¯æŒé™æ€èµ„æºçš„ä¸­é—´ä»¶

```
npm i sener sener-static
```

```js
import {Sener} from 'sener';
import {Static} from 'sener-static';
new Sener({
  middlewares: [new Static()], 
  // new Static({dir}); dir default value is ./public
});
```

å¯é€‰å‚æ•°ï¼š

```js
new Static({
  dir: './public', // Static directory, default value is ./public
})
```

### 3.5 form

æ”¯æŒformè¡¨å•å’Œæ–‡ä»¶ä¸Šä¼ çš„ä¸­é—´ä»¶

```
npm i sener sener-form
```

```js
import {Sener, Router} from 'sener';
import {Form} from 'sener-form';

const router = new Router({
    'post:/upload': ({ formData, files }) => {
        return { formData, files }
    },
});

new Sener({
  middlewares: [new Form(), router], 
  // new Form({dir}); dir default value is ./public
});
```

å¯é€‰å‚æ•°

```js
new Form({
  dir: './public/upload', // File upload directory, default value is ./public/upload
})
```

### 3.6 log

æ”¯æŒæ—¥å¿—æ‰“å°å’Œæ§åˆ¶çš„ä¸­é—´ä»¶

```
npm i sener sener-log
```

```js
import {Sener, Router} from 'sener';
import {Log} from 'sener-log';

const router = new Router({
    'get:/test': ({ query, logger }) => {
        logger.log('msg', 'payload')
        return { data: query }
    },
});

new Sener({
  middlewares: [new Log(), router], 
});
```

å£°æ˜æ–‡ä»¶

```ts
class Logger {
  log(msg: string | IMessageData, payload?: any, type?: TLogType): void;
  get traceid (): string;
  refreshDurationStart(): void;
  refreshTraceId(): void;
}

interface IMessageData {
  msg?: string;
  payload?: any;
  type?: 'error' | 'log' | 'warn' | 'info';
  level?: number;
  extend?: object;
}
```

å¯é€‰å‚æ•°

```js
new Log({
  dir: ''ï¼Œ // å­˜å‚¨æ—¥å¿—æ–‡ä»¶çš„ç›®å½•ã€‚é»˜è®¤å€¼ä¸ºâ€œâ€ï¼Œä½¿ç”¨æ ¹ç›®å½•
  useConsole: false, // æ˜¯å¦å¯ç”¨æ§åˆ¶å°.logæœåŠ¡è¿è¡Œæ—¶æ‰“å°æ—¥å¿—ã€‚ä¸å»ºè®®æ‰“å¼€ç”Ÿäº§ç¯å¢ƒã€‚é»˜è®¤å€¼ä¸º false
  maxRecords: 10000, // å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å­˜å‚¨è®°å½•æ•°ï¼Œé»˜è®¤å€¼ä¸º 10000
  level: -1, // æ—¥å¿—æ‰“å°çº§åˆ«ï¼Œçº§åˆ«å°äºæ­¤æ•°å­—çš„æ—¥å¿—å°†ä¸æ‰“å°
  // level?: ()=>number // çº§åˆ«ä¹Ÿå¯ä»¥æ˜¯ä¸€ç§åŠ¨æ€è·å–çº§åˆ«å€¼çš„æ–¹æ³•ï¼Œé€šå¸¸ä¸é…ç½®ä¸­é—´ä»¶ç»“åˆä½¿ç”¨
})
```

### 3.7 config

æ”¯æŒçµæ´»ä½¿ç”¨ JSON é…ç½®æ–‡ä»¶çš„ä¸­é—´ä»¶

```
npm i sener sener-config
```

```js
import {Sener, Router} from 'sener';
import {Config} from 'sener-config';

const router = new Router({
    'get:/test': ({ query, config, writeConfig, onConfigChange }) => {
        const level = config.level;
        level(); // read config
        level(5); // write config
        writeConfig('level', 5) // write config with writeConfig
        onConfigChange(({key, value, prev}) => { // on config change
            console.log(key, value, prev);
        })
        return { data: query }
    },
});

const config = new Config();

// Use config instance

config.onConfigChange(({key, value, prev}) => { // on config change
    console.log(key, value, prev);
});

config.data.level(); // read config

config.data.level(5); // write config

config.writeConfig('level', 2); // write config with writeConfig

new Sener({
  middlewares: [config, router], 
});
```

options

```ts
new Config({
  dir: '', // ç”¨äºä¿å­˜é…ç½®æ–‡ä»¶çš„ç›®å½•ã€‚é»˜è®¤å€¼ä¸ºâ€œâ€
  file: 'default', // é…ç½®æ–‡ä»¶çš„æ–‡ä»¶åã€‚é»˜è®¤å€¼ä¸ºâ€œé»˜è®¤å€¼â€
  // file: ['c1', 'c2'],  // ä¼ å…¥æ•°ç»„è¡¨ç¤ºä½¿ç”¨äº†å¤šä¸ªé…ç½®æ–‡ä»¶
  format: false, // æ˜¯å¦æ ¼å¼åŒ– JSON æ–‡ä»¶ã€‚é»˜è®¤å€¼ï¼šå¼€å‘ç¯å¢ƒä¸ºå‡ï¼Œç”Ÿäº§ç¯å¢ƒä¸ºçœŸ
})
```

### 3.8 mysql

æ”¯æŒmysqlè¿æ¥çš„ä¸­é—´ä»¶

```
npm i sener sener-mysql
```

```js
import {Sener, Router} from 'sener';
import {Mysql} from 'sener-mysql';

const router = new Router({
    'get:/test': async ({ query, querySql, mysqlConn }) => {
        const { results, fields } = await querySql('select * from user');
        // Or use mysqlConn
        return { data: query }
    },
});

const mysql = new Mysql({
  //  è¯¦æƒ…è¯·å‚è€ƒ [mysql](https://www.npmjs.com/package/mysql) 
}

mysql.connection;

new Sener({
  middlewares: [mysql, router], 
});
```

è¯¦æƒ…è¯·å‚è€ƒ [mysql](https://www.npmjs.com/package/mysql)


### 3.9 mongodb

æ”¯æŒmongodbè¿æ¥çš„ä¸­é—´ä»¶

```
npm i sener sener-mongodb
```

```js
import {Sener, Router} from 'sener';
import {Mongo} from 'sener-mongodb';

const router = new Router({
    'get:/test': async ({ query, queryMongoDB, mongoClient }) => {
        const {db, close} = await queryMongoDB('user');
        // do something
        // Or use mongoClient
        return { data: query }
    },
});

const mongodb = new Mongo({
  //  è¯¦æƒ…è¯·å‚è€ƒ [mongodb](https://www.npmjs.com/package/mongodb)
})

mongodb.client;

new Sener({
  middlewares: [mongodb, router], 
});
```

è¯¦æƒ…è¯·å‚è€ƒ [mongodb](https://www.npmjs.com/package/mongodb)

### 3.10 rpc middleware

rpc ä¸­é—´ä»¶ä½œç”¨æ˜¯å¯¹éƒ¨ç½²åœ¨ä¸åŒæœåŠ¡å™¨æˆ–è€…åŒä¸€æœåŠ¡å™¨ä¸åŒç«¯å£ä¸Šçš„æœåŠ¡è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œå¯ä»¥è®©å¼€å‘è€…åƒå‡½æ•°è°ƒç”¨ä¸€æ ·åƒè¿œç¨‹æœåŠ¡å‘èµ·è¯·æ±‚

ä¹Ÿå¯ç”¨äºwebå®¢æˆ·ç«¯åƒæœåŠ¡ç«¯å‘èµ·è¯·æ±‚çš„åœºæ™¯

è¯¥ä¸­é—´è¿˜ä¼šå‘è¯·æ±‚ä¸­æ³¨å…¥ x-trace-id headeræ¥ä¿è¯åŒä¸€æ¬¡è®¿é—®è°ƒç”¨çš„æ¥å£æœ‰ç›¸åŒçš„tracidï¼Œä¸logä¸­é—´ä»¶é…åˆä½¿ç”¨å¯ä»¥å¾ˆæœ‰æ•ˆçš„å®šä½é—®é¢˜

```
npm i sener sener-rpc
```

#### 3.10.1 æœåŠ¡ç«¯ä½¿ç”¨

1. ä½¿ç”¨é…ç½®

```js
import {Sener, Router} from 'sener';
import {RPC} from 'sener-rpc';

const router = new Router({
    'get:/test': async ({ query, rpc }) => {
        const list = rpc.comment.get('/message', {page: 1}); // url and query
        // use rpc.comment.request for more details
        return { data: {query, list} }
    },
});
new Sener({
  middlewares: [new RPC({
    user: 'http://localhost:3000', // user æœåŠ¡çš„è®¿é—®baseåœ°å€
    comment: 'http://localhost:3001', // comment æœåŠ¡çš„è®¿é—®baseåœ°å€
  }), router], 
});
```

2. ä½¿ç”¨createServiceså‡½æ•°

```js
import {Sener, Router} from 'sener';
import {RPC, Request} from 'sener-rpc';

class CommentRequest extends Request {
    getList ({ app = 'common', index = 1 }: {
        app?: string
        index?: number
    } = {}) {
        return this.get('/message', {
            app,
            index,
            size: 10,
        });
    }
}

function createServices(traceid = '') {
    const base = (port: number) => `http://localhost:${port}`;
    return {
        comment: new CommentRequest({ base: base(3001), traceid }),
    };
}

const router = new Router({
    'get:/test': async ({ query, rpc }) => {
        const list = rpc.comment.getList();
        return { data: {query, list} }
    },
});

new Sener({
  middlewares: [new RPC(createServices), router], 
});
```

#### 3.10.1 å®¢æˆ·ç«¯ä½¿ç”¨

1. npm å®‰è£…ä½¿ç”¨

```
npm i sener-rpc
```

```js
import {WebRPC} from 'sener-rpc/dist/web.umd';

// 1. å•ä¸ªæœåŠ¡å¯ä»¥ä¼ å…¥baseåœ°å€
const comment = new WebRPC('http://localhost:3001');
await comment.get('/message', {page: 1});

// 2. å¤šä¸ªæœåŠ¡ä¼ å…¥map
const rpc = new WebRPC({
    user: 'http://localhost:3000', // user æœåŠ¡çš„è®¿é—®baseåœ°å€
    comment: 'http://localhost:3001', // comment æœåŠ¡çš„è®¿é—®baseåœ°å€
});
await rpc.comment.get('/message', {page: 1});

// 3. ä½¿ç”¨ç»§æ‰¿æ–¹å¼
class Comment extends WebRPC {
    getList ({ app = 'common', index = 1 }: {
        app?: string
        index?: number
    } = {}) {
        return this.get('/message', {
            app,
            index,
            size: 10,
        });
    }
}
await (new Comment()).getList();
```

2. cdn ä½¿ç”¨

```html
<script src='https://cdn.jsdelivr.net/npm/sener-rpc'></script>
<script>
  SenerRpc.WebRPC
</script>
```

## å…¶ä»–

1. Dir

Sener é»˜è®¤å°†æ‰€æœ‰æ•°æ®æ–‡ä»¶å­˜å‚¨åœ¨ ~/sener-data æ–‡ä»¶å¤¹ä¸­

```js
let BASE_SENER_DIR = path.resolve(homedir(), './sener-data')
```

å¦‚æœæƒ³è¦ä¿®æ”¹è¿™ä¸ªç›®å½•ï¼Œè¯·ä½¿ç”¨seneré™æ€å±æ€§

```ts
Sener.Dir = 'xxxxx'
```

2. Version

è·å–ç‰ˆæœ¬å·

```ts
Sener.Version
```

## è‡ªå®šä¹‰ä¸­é—´ä»¶

æ–‡æ¡£å°†æŒç»­å®Œå–„ä¸­

ç°åœ¨è¯·å‚è€ƒ [ä¸­é—´ä»¶åŒ…](https://github.com/theajack/sener/blob/master/packages)


